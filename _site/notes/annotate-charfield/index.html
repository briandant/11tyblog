<h1>annotating a django queryset with a charfield</h1>
<p><time class="text-3xl" datetime="Sat Oct 26 2024 10:29:48 GMT-0400 (Eastern Daylight Time)">Sat Oct 26 2024 10:29:48 GMT-0400 (Eastern Daylight Time)</time></p>
<p>Say that I'm putting together an inventory of my daughter's lost snacks.  And I want to see all the Skittles that are in the couch cushions.  That would never happen in my house, but ya know.</p>
<p>Let's also say that we have the constraint of using Django Filters, rather than doing something in a template.</p>
<p>I have a model:</p>
<pre><code class="language-python">from django.db import models

class Locations(models.Model):
    name = models.CharField(
        max_length=255, choices=[&quot;cabinet&quot;, &quot;couch&quot;, &quot;under-bed&quot;]
    )

class Skittles(models.Model):
    color = models.CharField(max_length=255)

class SkittleLocation(models.Model):
    skittle = models.ForeignKey(Skittles, on_delete=models.CASCADE)
    location = models.ForeignKey(Locations, on_delete=models.CASCADE)
</code></pre>
<p>And I want to display all of them in the filter view, but I want the dropdown to show <code>red - couch</code>.</p>
<p>Django filters doesn't have a convenient way to dynamically build the choices, other than a custom <code>ChoiceFilter</code>, from what I can see.  And once we do all that, we'll just be putting a query into some <code>get_choice</code> method or whatever.  So I thought it would be easier to just add an annotated field and return a <code>values_list</code>:</p>
<pre><code class="language-python">from django.db import models
from django.db.models import Value
from django.db.models.functions import Concat

class SnacksFilter(django_filters.FilterSet):
    ...
    skittles = django_filters.ChoiceFilter(
    choices=
        SkittleLocation.objects.all()
            .order_by(&quot;color&quot;)
            .annotate(
            display=Concat(
                models.F(&quot;skittle__color&quot;),
                Value(&quot;-&quot;),
                models.F(&quot;location__name&quot;),
                output_field=models.CharField(),
            ),
        )
    .values_list(&quot;id&quot;, &quot;display&quot;)
    )
    ,
    ...
</code></pre>
<p>With some help from: <a href="https://stackoverflow.com/a/50682754">https://stackoverflow.com/a/50682754</a>.</p>
